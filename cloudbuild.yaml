steps:
- id: 'validate tfplan output'
  name: 'gcr.io/cloud-builders/docker:18.09.6'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
      if [ -d "consolidated/" ]; then
   
       chmod 755 terraform-validator-linux-amd64;
       ./terraform-validator-linux-amd64 validate consolidated/cloudresources/tfplan900.tfplan.json --policy-path=consolidated/policy-library/ --project=$PROJECT_ID >> /workspace/result.txt 
        echo "$?"
        cat /workspace/result.txt
      else
        echo " Relevant resources didn't exist......"
      fi

     
- id: Save validator result to GCS 
  name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp','-r','/workspace/result.txt','gs://tfcode_vali/$BUILD_ID/result.txt']


- id: 'Execute for GCP Resources'
  name: 'hashicorp/terraform:0.12.0'
  #name: 'gcr.io/cloud-builders/docker:18.09.6'
  #name: 'centos:latest'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
      if [ -e "/workspace/result.txt" ]; then
           echo "$?"
            fcount=0;
             fcount=`grep "Constraint" /workspace/result.txt | awk '{print $1}'|sort| uniq -c|awk '{print $1}'`;
             echo "$fcount";
            if [ $fcount != 0 ];then
              echo "Violation Found...Don't execute code for cloud resources";
            else 
                echo "No Violation found...Apply on resources";
                #terraform apply -auto-approve
            fi
        else
        echo "Result file didn't generate/exist";
      fi

